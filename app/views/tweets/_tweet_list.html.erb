<%= "<ul class=\"user-messages\" id=\"messages-for-channel-#{channel.id}\">" unless @no_wrap %>
  <% first_post_in_a_merge = false %>
  <% last_post_in_a_merge  = false %>
  <% showed_wrapper_start    = false %>
  <% showed_wrapper_end      = false %>
  <% merging = false %>
  <%- tweets.each_with_index do |t, i| -%>

    <% same_poster_as_next = (t.user.id == (tweets[i + 1] && tweets[i + 1].user.id)) && !t.text_extension? %>

    <% last_id = (same_poster_as_next ? (tweets[(i + 1)..25].find {|innertweet| (innertweet.user.id != t.user.id) || innertweet.text_extension? } || tweets.last).id : t.id) %>

    <% merging = true if same_poster_as_next %>

    <% first_post_in_a_merge = same_poster_as_next && !showed_wrapper_start %>
    <% showed_wrapper_start = true if first_post_in_a_merge %>

    <% last_post_in_a_merge  = (!same_poster_as_next && merging) %>

    <% show_wrapper_start = !merging || first_post_in_a_merge %>
    <% show_wrapper_end   = !merging || last_post_in_a_merge %>

    <% merging = false if last_post_in_a_merge %>
    <% show_wrapper_start = false if last_post_in_a_merge %>
    <% showed_wrapper_start = false if last_post_in_a_merge %>
    

    <%= render :partial => '/tweets/tweet', :locals => {:message => t.message, :avatar => t.user.active_avatar_url,
                                                        :author => t.author, :created_at => t.created_at,
                                                        :html_id => "tweet-#{last_id}", :show_wrapper_start => show_wrapper_start, :show_wrapper_end => show_wrapper_end } %>
    <%- if t.text_extension? -%>
    <script type="text/javascript">//<![CDATA[
      protonet.globals.textExtensions.push({
        container_id: <%= "tweet-#{t.id}".to_json %>,
        data: <%= t.text_extension %>
      });
    //]]></script>
    <%- end -%>
  <%- end -%>
<%= "</ul>" unless @no_wrap %>