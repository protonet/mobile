<%= render "shared/nav_users"%>
<output class="content" data-tab="users">
  <h2><%= t("users.headline_edit", :display_name => @user.display_name) %> <a data-hover-hint="top" title="<%= t("users.hint_edit") %>" class="hint">(?)</a></h2>
  
  <%= render :partial => 'avatar' %>
  
  <%- unless @user.stranger? && @user.anonymous? %>
    <h3><%= t("users.headline_edit_details") %></h3>
    <%- if SystemPreferences.remote_ldap_sign_on == true -%>
      <p class="hint"><%= t("users.hint_edit_details") %></p>
    <%- else %>
      <%= form_for(@user, {
        :url        => user_path,
        :method     => :update,
        :remote     => true,
        :html       => { 'data-type' => 'html', 'data-cucumber' => 'user-details' }
      }) do |f| -%>
        <%= hidden_field_tag :user_type, @user.class.to_s.underscore %>
        <%= hidden_field_tag :user_id, @user.id %>
        <%= f.hidden_field :id %>
        <div class="form-field">
          <%= f.label :first_name, t("users.label_first_name") %>
          <%= f.text_field :first_name %>
        </div>
        <div class="form-field">
          <%= f.label :last_name, t("users.label_last_name") %>
          <%= f.text_field :last_name %>
        </div>
        <div class="form-field">
          <%= f.label :login, t("users.label_user_name") %>
          <%= f.text_field :login %>
        </div>
        <div class="form-field">
          <%= f.label :email, t("users.label_email") %>
          <%= f.text_field :email %>
        </div>
        <%= button t("label_save") %>
      <%- end %>
    <% end %>
  <%- end %>
  
  <%- unless @user.stranger? && @user.anonymous? %>
    <%- unless SystemPreferences.remote_ldap_sign_on -%>
      <%- if current_user.admin? && current_user != @user %>
        <h3><%= t("users.headline_reset_password") %></h3>
        <%= form_tag({ :action => 'generate_new_password' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'change-password', :class => 'single-button-form' }) do %>
          <%= hidden_field_tag :id, @user.id %>
          <%= hidden_field_tag :user_id, @user.id %>
          <%= button t("users.label_generate_new_password") %>
          <%= button t("users.label_generate_new_password_and_send"), :name => 'send_email', :value => true %>
        <% end %>
      <%- else %>
        <h3><%= t("users.headline_change_password") %></h3>
        <%= form_tag({ :action => 'change_password' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'change-password' }) do %>
          <%= hidden_field_tag :id, @user.id %>
          <div class="form-field">
            <%= label_tag :current_password, t("users.label_old_password") %>
            <%= password_field_tag :current_password, nil %>
          </div>
          <div class="form-field">
            <%= label_tag :password, t("users.label_new_password") %>
            <%= password_field_tag :password, nil %> <a data-hover-hint="top" title="<%= t("users.hint_password") %>" class="hint">(?)</a>
          </div>
          <%= button t("label_save") %>
        <% end %>
      <%- end %>
    <%- end -%>
  <%- end %>
  
  <%- unless @user.stranger? && @user.anonymous? %>
    <h3><%= t("users.headline_notifications") %></h3>
    <%= form_for(@user, {
      :url        => user_path,
      :method     => :update,
      :remote     => true,
      :html       => { 
        'data-type' => 'html', 
        'data-cucumber' => 'user-notification',
        'data-ajax-auto-submit' => '1' 
      }
    }) do |f| -%>
      <%= hidden_field_tag :user_type, @user.class.to_s.underscore %>
      <%= hidden_field_tag :user_id, @user.id %>
      <%= f.hidden_field :id %>
        <label class="checkbox-row">
          <%= f.check_box :notify_me %>
          <%= t("users.label_notify_me") %>
        </label>
    <%- end %>
    <div id="settings"></div>
  <%- end %>
  
  <%- if current_user.admin? && !@user.stranger?  && !@user.anonymous? -%>
    <h3><%= t("users.headline_permissions") %> <a data-hover-hint="top" title="<%= t("users.hint_admins_can_see_this") %>" class="hint">(?)</a></h3>
    <div class="info-box">
      <h4><%= t("users.headline_user_types") %></h4>
      <p><%= raw(t("users.hint_user_types")) %></p>
    </div>
    
    <%= form_tag({ :action => 'update_roles' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'admin-settings' }) do %>
      <%= hidden_field_tag :id, @user.id %>
      <%= hidden_field_tag :user_id, @user.id %>
      
      <div class="form-field">
        <%= label_tag 'role-invitee', t("users.label_user_with_restricted_rights") %>
        <%= radio_button_tag :role, 'invitee', @user.invitee?, :id => 'role-invitee' %>
        <a data-hover-hint="top" title="<%= raw(t("users.hint_user_with_restricted_rights")) %>" class="hint">(?)</a>
      </div>
      <div class="form-field">
        <%= label_tag 'role-user', t("users.label_user_default") %>
        <%= radio_button_tag :role, 'user', !@user.invitee? && !@user.admin?, :id => 'role-user' %>
        <a data-hover-hint="top" title="<%= raw(t("users.hint_user_default")) %>" class="hint">(?)</a>
      </div>
      <div class="form-field">
        <%= label_tag 'role-admin', t("users.label_user_with_administration_rights") %>
        <%= radio_button_tag :role, 'admin', @user.admin?, :id => 'role-admin' %>
        <a data-hover-hint="top" title="<%= raw(t("users.hint_user_with_administration_rights")) %>" class="hint">(?)</a>
      </div>
      
      <%= button t("label_save") %>
    <% end %>
  <%- end -%>
  
  <%- if current_user.admin? && !@user.anonymous? %>
    <h3><%= t("users.headline_delete")%> <a data-hover-hint="top" title="<%= t("users.hint_admins_can_see_this") %>" class="hint">(?)</a></h3>
    <%= form_tag({ :action => 'delete' }, { :remote => true, :class => 'single-button-form', 'data-type' => 'html' }) do %>
      <%= hidden_field_tag :user_id, @user.id %>
      <%= hidden_field_tag :id, @user.id %>
      <%= button t("label_delete"), 'data-confirm' => t("users.confirm_delete") %>
    <% end %>
  <%- end %>
  
  <script type="protonet/template" id="user-roles-table-template">
    <%= render :partial => 'shared/user_roles_table' %>
  </script>
</output>