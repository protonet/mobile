<%= render "shared/nav_users"%>
<output class="content" data-tab="users">
  <h2>Edit @<%= @user.display_name %> <a data-hover-hint="top" title="This page can only be seen by admins and the user himself" class="hint">(?)</a></h2>
  
  <%= render :partial => 'avatar' %>
  
  <%- unless @user.stranger? && @user.anonymous? %>
    <h3>Edit user details</h3>
    <%- if SystemPreferences.remote_ldap_sign_on == true -%>
      <p class="hint">You can't edit user details since the admin of this node enabled ldap authentication.</p>
    <%- else %>
      <%= form_for(@user, {
        :url        => user_path,
        :method     => :update,
        :remote     => true,
        :html       => { 'data-type' => 'html', 'data-cucumber' => 'user-details' }
      }) do |f| -%>
        <%= hidden_field_tag :user_type, @user.class.to_s.underscore %>
        <%= hidden_field_tag :user_id, @user.id %>
        <%= f.hidden_field :id %>
        <div class="form-field">
          <%= f.label :first_name, 'First name:' %>
          <%= f.text_field :first_name %>
        </div>
        <div class="form-field">
          <%= f.label :last_name, 'Last name:' %>
          <%= f.text_field :last_name %>
        </div>
        <div class="form-field">
          <%= f.label :login, 'User name:' %>
          <%= f.text_field :login %>
        </div>
        <div class="form-field">
          <%= f.label :email, 'E-Mail:' %>
          <%= f.text_field :email %>
        </div>
        <%= button "Save" %>
      <%- end %>
    <% end %>
  <%- end %>
  
  <%- unless @user.stranger? && @user.anonymous? %>
    <%- unless SystemPreferences.remote_ldap_sign_on -%>
      <%- if current_user.admin? && current_user != @user %>
        <h3>Reset password</h3>
        <%= form_tag({ :action => 'generate_new_password' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'change-password', :class => 'single-button-form' }) do %>
          <%= hidden_field_tag :id, @user.id %>
          <%= hidden_field_tag :user_id, @user.id %>
          <%= button "Generate new" %>
          <%= button "Generate new and send to user via email", :name => 'send_email', :value => true %>
        <% end %>
      <%- else %>
        <h3>Change password</h3>
        <%= form_tag({ :action => 'change_password' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'change-password' }) do %>
          <%= hidden_field_tag :id, @user.id %>
          <div class="form-field">
            <%= label_tag :current_password, 'Old password:' %>
            <%= password_field_tag :current_password, nil %>
          </div>
          <div class="form-field">
            <%= label_tag :password, 'New password:' %>
            <%= password_field_tag :password, nil %> <a data-hover-hint="top" title="Minimum 8 characters" class="hint">(?)</a>
          </div>
          <%= button "Save" %>
        <% end %>
      <%- end %>
    <%- end -%>
  <%- end %>
  
  <%- if current_user.admin? && !@user.stranger?  && !@user.anonymous? -%>
    <h3>Permissions <a data-hover-hint="top" title="Only visible to admins" class="hint">(?)</a></h3>
    <div class="info-box">
      <h4>User types</h4>
      <p><a id="show-comparison-chart">Learn more</a> about the different user types and their permissions.</p>
    </div>
    
    <%= form_tag({ :action => 'update_roles' }, { :remote => true, 'data-type' => 'html', 'data-cucumber' => 'admin-settings' }) do %>
      <%= hidden_field_tag :id, @user.id %>
      <%= hidden_field_tag :user_id, @user.id %>
      
      <div class="form-field">
        <%= label_tag 'role-invitee', 'User with restricted rights:' %>
        <%= radio_button_tag :role, 'invitee', @user.invitee?, :id => 'role-invitee' %>
        <a data-hover-hint="top" title="<h4>User with restricted rights</h4> Users with restricted rights can only see channels they were susbcribed to (by an administrator). They aren't able to see users from other channels. This user type can be perfectly used for customers or guests that should have limited access." class="hint">(?)</a>
      </div>
      <div class="form-field">
        <%= label_tag 'role-user', 'User:' %>
        <%= radio_button_tag :role, 'user', !@user.invitee? && !@user.admin?, :id => 'role-user' %>
        <a data-hover-hint="top" title="<h4>User</h4> Normal users can see all channels and users. They're not allowed to delete users or channels that they didn't create." class="hint">(?)</a>
      </div>
      <div class="form-field">
        <%= label_tag 'role-admin', 'Administrator:' %>
        <%= radio_button_tag :role, 'admin', @user.admin?, :id => 'role-admin' %>
        <a data-hover-hint="top" title="<h4>Administrator</h4> Users with administration rights can manage channels, other users and system related things." class="hint">(?)</a>
      </div>
      
      <%= button "Save" %>
    <% end %>
  <%- end -%>
  
  <%- if current_user.admin? && !@user.anonymous? %>
    <h3>Delete user <a data-hover-hint="top" title="Only visible to admins" class="hint">(?)</a></h3>
    <%= form_tag({ :action => 'delete' }, { :remote => true, :class => 'single-button-form', 'data-type' => 'html' }) do %>
      <%= hidden_field_tag :user_id, @user.id %>
      <%= hidden_field_tag :id, @user.id %>
      <%= button "Delete", 'data-confirm' => 'Do you really want to delete this user? There\'s no undo.' %>
    <% end %>
  <%- end %>
  
  <script type="protonet/template" id="user-roles-table-template">
    <%= render :partial => 'shared/user_roles_table' %>
  </script>
</output>