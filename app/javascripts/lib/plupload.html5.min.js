(function(c){function b(e,f){var d;if("FileReader" in window){d=new FileReader();d.readAsDataURL(e);d.onload=function(){f(d.result)}}else{return f(e.getAsDataURL())}}function a(k,m,j,d,l){var f,e,i,h,g;b(k,function(n){f=document.createElement("canvas");f.style.display="none";document.body.appendChild(f);e=f.getContext("2d");i=new Image();i.onload=function(){var q,o,p;g=Math.min(m/i.width,j/i.height);if(g<1){q=Math.round(i.width*g);o=Math.round(i.height*g)}else{q=i.width;o=i.height}f.width=q;f.height=o;e.drawImage(i,0,0,q,o);n=f.toDataURL(d);n=n.substring(n.indexOf("base64,")+7);n=atob(n);f.parentNode.removeChild(f);l({success:true,data:n})};i.src=n})}c.runtimes.Html5=c.addRuntime("html5",{getFeatures:function(){var j,e,i,f,d,h,g=window;e=i=f=d=h=false;if(g.XMLHttpRequest){j=new XMLHttpRequest();i=!!j.upload;e=!!(j.sendAsBinary||j.upload)}if(e){f=!!(File&&(File.prototype.getAsDataURL||g.FileReader)&&j.sendAsBinary);d=!!(File&&File.prototype.slice);h="draggable" in document.createElement("div")&&!!window.FileList}return{html5:e,dragdrop:h,jpgresize:f,pngresize:f,multipart:f||!!g.FileReader||!!g.FormData,progress:i,chunking:d||f}},init:function(g,h){var d={},e;function f(m){var k,j,l=[],n;for(j=0;j<m.length;j++){k=m[j];n=c.guid();d[n]=k;l.push(new c.File(n,k.fileName,k.fileSize))}if(l.length){g.trigger("FilesAdded",l)}}e=this.getFeatures();if(!e.html5){h({success:false});return}g.bind("Init",function(n){var r,p=[],m,q,k=n.settings.filters,l,o,j=document.body;r=document.createElement("div");r.id=n.id+"_html5_container";for(m=0;m<k.length;m++){l=k[m].extensions.split(/,/);for(q=0;q<l.length;q++){o=c.mimeTypes[l[q]];if(o){p.push(o)}}}c.extend(r.style,{position:"absolute",background:g.settings.shim_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",zIndex:99999,opacity:g.settings.shim_bgcolor?"":0});r.className="plupload html5";if(g.settings.container){j=document.getElementById(g.settings.container);j.style.position="relative"}j.appendChild(r);r.innerHTML='<input id="'+g.id+'_html5" style="width:100%;" type="file" accept="'+p.join(",")+'" '+(g.settings.multi_selection?'multiple="multiple"':"")+" />";document.getElementById(g.id+"_html5").onchange=function(){f(this.files);this.value=""}});g.bind("PostInit",function(){var i=document.getElementById(g.settings.drop_element);if(i){c.addEvent(i,"dragover",function(j){j.preventDefault()});c.addEvent(i,"drop",function(k){var j=k.dataTransfer;if(j&&j.files){f(j.files)}k.preventDefault()})}});g.bind("Refresh",function(i){var j,k,l;j=document.getElementById(g.settings.browse_button);k=c.getPos(j,document.getElementById(i.settings.container));l=c.getSize(j);c.extend(document.getElementById(g.id+"_html5_container").style,{top:k.y+"px",left:k.x+"px",width:l.w+"px",height:l.h+"px"})});g.bind("UploadFile",function(i,k){var l=i.settings,n,j;function m(o){var r=0,q=0;function p(){var x=o,F,G,B,C,D=0,u="----pluploadboundary"+c.guid(),w,z,v="--",E="\r\n",A="",t,s=i.settings.url;if(k.status==c.DONE||k.status==c.FAILED||i.state==c.STOPPED){return}C={name:k.target_name||k.name};if(l.chunk_size&&e.chunking){w=l.chunk_size;B=Math.ceil(k.size/w);z=Math.min(w,k.size-(r*w));if(typeof(o)=="string"){x=o.substring(r*w,r*w+z)}else{x=o.slice(r*w,z)}C.chunk=r;C.chunks=B}else{z=k.size}F=new XMLHttpRequest();G=F.upload;if(G){G.onprogress=function(H){k.loaded=Math.min(k.size,q+H.loaded-D);i.trigger("UploadProgress",k)}}if(!i.settings.multipart||!e.multipart){s=c.buildUrl(i.settings.url,C)}else{C.name=k.target_name||k.name}F.open("post",s,true);F.onreadystatechange=function(){var H,J;if(F.readyState==4){try{H=F.status}catch(I){H=0}if(H>=400){i.trigger("Error",{code:c.HTTP_ERROR,message:"HTTP Error.",file:k,status:H})}else{if(B){J={chunk:r,chunks:B,response:F.responseText,status:H};i.trigger("ChunkUploaded",k,J);q+=z;if(J.cancelled){k.status=c.FAILED;return}k.loaded=Math.min(k.size,(r+1)*w)}else{k.loaded=k.size}i.trigger("UploadProgress",k);if(!B||++r>=B){k.status=c.DONE;i.trigger("FileUploaded",k,{response:F.responseText,status:H})}else{p()}}}};c.each(i.settings.headers,function(I,H){F.setRequestHeader(H,I)});if(i.settings.multipart&&e.multipart){if(!F.sendAsBinary){var y=new FormData();c.each(c.extend(C,i.settings.multipart_params),function(I,H){y.append(H,I)});y.append(i.settings.file_data_name,x);F.send(y);return}F.setRequestHeader("Content-Type","multipart/form-data; boundary="+u);c.each(c.extend(C,i.settings.multipart_params),function(I,H){A+=v+u+E+'Content-Disposition: form-data; name="'+H+'"'+E+E;A+=I+E});t=c.mimeTypes[k.name.replace(/^.+\.([^.]+)/,"$1")]||"application/octet-stream";A+=v+u+E+'Content-Disposition: form-data; name="'+i.settings.file_data_name+'"; filename="'+k.name+'"'+E+"Content-Type: "+t+E+E+x+E+v+u+v+E;D=A.length-x.length;x=A}else{F.setRequestHeader("Content-Type","application/octet-stream")}if(F.sendAsBinary){F.sendAsBinary(x)}else{F.send(x)}}p()}n=d[k.id];j=i.settings.resize;if(e.jpgresize){if(j&&/\.(png|jpg|jpeg)$/i.test(k.name)){a(n,j.width,j.height,/\.png$/i.test(k.name)?"image/png":"image/jpeg",function(o){if(o.success){k.size=o.data.length;m(o.data)}else{m(n.getAsBinary())}})}else{m(n.getAsBinary())}}else{m(n)}});h({success:true})}})})(plupload);