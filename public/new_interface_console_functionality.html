<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="javascripts/jquery-1.3.1.js" type="text/javascript" charset="utf-8"></script>
    <script src="javascripts/jquery-ui-personalized-1.6rc6.js" type="text/javascript" charset="utf-8"></script>
    <script src="javascripts/jquery.scrollTo.js" type="text/javascript" charset="utf-8"></script>

    <title>new interface test</title>
    <style type="text/css" media="screen">
      * {
        margin: 0px;
        padding: 0px;
      }
      div {
        border: 1px solid black;
      }
      #viewport {
        font-size: 20px;
        padding: 20px;
        width: 600px;
      }
      #viewport textarea {
        font-size: 20px;
      }
      #whatshappening_questionmark {
        font-size: 14px;
        padding: 0 5px;
      }
    </style>
  </head>

  <!-- slide to top:-641px; bzw. top: 0px; -->

  <body>

  <div id="viewport">
  
    <h3>input console test</h3><br />
    
    <label for="console">console</label>
    <textarea id="console" name="console" rows="4" cols="40"></textarea>
    

  </div>
  <br />
  output:
  <div id="whatshappening_questionmark">
    
  </div>

  <script type="text/javascript" charset="utf-8">
    function CommandBlob(args) {
      
    }
    
    CommandBlob.prototype = {
      "foobar": function() {
        
      }
    }
  
    function InputConsole(args) {
      var self = this;
      this.input_console  = args.input_console;
      this.output_console = args.output_console;
      this.console_mode = false;
      
      // bind keydown handling for tab key catching
      this.input_console.keydown(function(event) {
        self.tabHandler(event);
      });
      
      // bind event handling on the input
      this.input_console.keyup(function(event) {
        self.eventHandler(event);
      });
      
    }
    
    InputConsole.prototype = {
      // error checker
      "errorCheck": function(event) {
        if(this.console_mode)
        {
          // @person
          // allowed
          
          // @@audience
          // allowed
          
          // @person.command
          // allowed for commands ['direct', 'important', 'send_file', 'secure', 'dis']
          
          // @@audience.person.command
          // allowed for commands ['direct', 'important', 'send_file', 'secure', 'dis']
          
          // @@audience.command
          // allowed for commands ['important']
          
          // @@audience.subaudience.subaudience...
          // allowed
          
          // @@audience.subaudience...person
          // allowed
          
          // @person.command.command.command
        }
      },
      
      "eventHandler": function(event) {
        // handle event preparation
        // optimizable: move it into a function only called when one of the triggers has happened
        var currentTarget   = event.currentTarget;
        var selectionEndsAt = event.currentTarget.selectionEnd;
        var selectionIndex  = selectionEndsAt - 1;
        
        // retrieve the previous character
        if(selectionIndex == 0)
        {
          var previousCharacter= null;
          var currentCharacter = currentTarget.value.substr((selectionIndex), 1);
        }
        else
        {
          var previousCharacter= currentTarget.value.substr((selectionIndex - 1), 1);
          var currentCharacter = currentTarget.value.substr((selectionIndex), 1);
        }
        
        // console.log(event);
        console.log("prev", previousCharacter, 'current', currentCharacter);
        
        switch(event.which) {
          // case @
          // probably start of command sequence
          case 50:
            // check wether the previous character is a space
            // if yes this is the beginning of a command sequence
            if(previousCharacter == ' ' || !previousCharacter)
            {
              console.log('entering console mode');
              console.log('person mode')
              this.console_mode = 'person';
            }
            // check wether the previous character is a @
            // if yes the user is now trying to talk to a channel rather
            // than an end user
            else if(currentCharacter == '@' && this.console_mode == 'person')
            {
              console.log('audience mode')
              this.console_mode = 'audience';
            }
            else
            {
              console.log('an error might have occured!');
            }
            // error handling???
            
            // this.output_console.text(this.input_console);
            break;
          // case 
          
          // case space
          // end of command sequence
          case 32:
            if(this.console_mode) 
            {
              this.console_mode = false;
              console.log('leaving console mode');
            }
            else
            {
              // do nothing
            }
            break;
            
          case 'foobar':
            break;
        }
        // output.text(input_console.attr('value'));
      },
      
      "tabHandler": function(event) {
        switch(event.which) {
          case 9:
            console.log('requesting help');
            event.stopPropagation();
            event.stopImmediatePropagation();
            event.preventDefault();
            event.cancelBubble = true
            // debugger;
            break;
        }
        
      },
      
      "prepareDataForHandler": function(event) {
        //test
      }
      
    }    
    
    input_console = new InputConsole({"input_console": $("#console"), "output_console": $("#whatshappening_questionmark")});
    
  </script>
  </body>
</html>
