##########################################################################
# monit settings for every node
##########################################################################

# refresh rate
set daemon 30

# logfile configuration
set logfile syslog facility log_daemon

# control and http interface
set httpd port 2812
allow @admin
allow localhost
# following line is added since monit command line needs this to communicate with the monitoring
allow monituser:<%= monit_password %>

##########################################################################
# default processes, more are added in runtime at shared/config/monit.d/*
##########################################################################

# app  settings
check process rabbitmq with pidfile /var/run/rabbitmq/pid
  group base
  start program = "/usr/bin/sudo /etc/init.d/rabbitmq-server start"
  stop program  = "/usr/bin/sudo /etc/init.d/rabbitmq-server stop"
  if totalmem > 100.0 MB for 20 cycles then restart
  if totalmem > 200.0 MB for 10 cycles then restart

check process apache2 with pidfile /var/run/apache2.pid
  group base
  start program = "/usr/bin/sudo /etc/init.d/apache2 start"
  stop program  = "/usr/bin/sudo /etc/init.d/apache2 stop"
  if totalmem > 800.0 MB for 5 cycles then restart
  if children > 250 then restart
  depends on rabbitmq

check process node.js with pidfile <%= shared_path %>/pids/node_8124.pid
  group daemons
  start program = "<%= current_path %>/script/init/node start"
  stop program  = "<%= current_path %>/script/init/node stop"
  if 3 restarts within 5 cycles then timeout
  if totalmem > 200.0 MB for 2 cycles then restart
  depends on rabbitmq

check process js_dispatcher with pidfile <%= shared_path %>/pids/js_dispatcher_production.pid
  group daemons
  start program = "<%= current_path %>/script/monit_bundle_exec production <%= current_path %> ruby <%= current_path %>/messaging/js_dispatching_control.rb start"
  stop program  = "<%= current_path %>/script/monit_bundle_exec production <%= current_path %> ruby <%= current_path %>/messaging/js_dispatching_control.rb stop"
  if 3 restarts within 5 cycles then timeout
  if totalmem > 200.0 MB for 4 cycles then restart
  depends on rabbitmq

check process solr with pidfile <%= shared_path %>/pids/sunspot-solr.pid
  group solr
  start program = "<%= current_path %>/script/init/solr start"
  stop program  = "<%= current_path %>/script/init/solr stop"
  if 3 restarts within 5 cycles then timeout

# Watch for dropped RAID disks hourly
# Return status is flipped (1 is good) so that the output can be used at some point
check program raid with path "<%= current_path %>/script/monit_raid_check"
  if status == 0 then exec "/bin/bash -l -c 'cd <%= current_path %> && RAILS_ENV=production bundle exec rake report:raid_fail'"
  every 120 cycles

# Antivir scan should be performed hourly
check program clamav with path "<%= current_path %>/script/monit_clamav"
  if status == 1 then alert
  every 120 cycles

# Watch netatalk/afpd
check host afpd with address 127.0.0.1
  start program = "/usr/bin/sudo /etc/init.d/netatalk start"
  stop program  = "/usr/bin/sudo /etc/init.d/netatalk stop"
  if failed port 548 for 5 cycles then restart

<% if false && jabber_bridge_active %>
  check process jabber.rb with pidfile <%= shared_path %>/pids/jabber.rb.pid
    group daemons
    start program = "<%= current_path %>/script/monit_bundle_exec production <%= current_path %> ruby <%= current_path %>/messaging/jabber_control.rb start"
    stop program  = "<%= current_path %>/script/monit_bundle_exec production <%= current_path %> ruby <%= current_path %>/messaging/jabber_control.rb stop"
    if 10 restarts within 10 cycles then timeout
    if totalmem > 200.0 MB for 2 cycles then restart
    depends on rabbitmq
<% end %>

include <%= shared_path %>/config/monit.d/*